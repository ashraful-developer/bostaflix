<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ayna Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    #player {
      width: 90%;
      height: 80vh;
      background: #111;
      border: 2px solid #222;
      border-radius: 12px;
      overflow: hidden;
    }
    #status {
      margin-top: 10px;
      font-size: 16px;
      color: #0f0;
      text-shadow: 0 0 5px #0f0;
      transition: opacity 0.4s ease;
    }
    #status.hidden {
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="player"></div>
  <div id="status" class="hidden"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const title = params.get("id"); // ?id=Channel I
    if (!title) {
      document.body.innerHTML = "<h3>Missing ?id= parameter</h3>";
      throw new Error("Missing ?id= parameter");
    }

    let player;
    let servers = [];
    let currentIndex = 0;
    const statusDiv = document.getElementById("status");

    function showStatus(message, color = "#0f0") {
      statusDiv.textContent = message;
      statusDiv.style.color = color;
      statusDiv.classList.remove("hidden");
      clearTimeout(statusDiv.hideTimeout);
      statusDiv.hideTimeout = setTimeout(() => {
        statusDiv.classList.add("hidden");
      }, 4000);
    }

    async function loadStreams() {
      try {
        console.log(`[INIT] Loading streams for: ${title}`);

        // Fetch JSON data
        const [aynaRes, proxyRes] = await Promise.all([
          fetch("ayna.json"),
          fetch("ayna-proxy.json")
        ]);
        const [aynaData, proxyData] = await Promise.all([
          aynaRes.json(),
          proxyRes.json()
        ]);

        // Find matching channel
        const real = aynaData.data.list.find(ch => ch.title.toLowerCase() === title.toLowerCase());
        const backup = proxyData.data.list.find(ch => ch.title.toLowerCase() === title.toLowerCase());

        if (!real) throw new Error("Channel not found in ayna.json");
        if (!backup) console.warn("No matching entry found in ayna-proxy.json");

        // Construct URLs
        const mainUrl = `https://aynaott.com/live/${real.id}/index.m3u8`;
        const backupApi = backup
          ? `https://bostacdn.global.ssl.fastly.net/zuzz/rest_api.php?action=get_channel_detail&streamid=${encodeURIComponent(backup.id)}`
          : null;
        const phpProxy = `https://aynaxbosta.global.ssl.fastly.net/Ayna/play.php?id=${real.id}`;

        servers = [mainUrl];
        if (backupApi) servers.push(backupApi);
        servers.push(phpProxy);

        console.log("[SERVERS] Stream list:", servers);
        showStatus(`Loading: ${title}`);

        // Start playback
        initPlayer(servers[currentIndex]);
      } catch (err) {
        console.error("[ERROR] Failed to load streams:", err);
        document.body.innerHTML = "<h3>Could not load stream sources.</h3>";
      }
    }

    function initPlayer(url) {
      console.log(`[PLAYER] Loading source #${currentIndex + 1}: ${url}`);

      if (player) player.destroy();
      player = new Clappr.Player({
        source: url,
        parentId: "#player",
        autoPlay: true,
        width: "100%",
        height: "100%",
        playback: { playInline: true },
      });

      // Event listeners
      player.on(Clappr.Events.PLAYER_ERROR, handleError);
      player.on(Clappr.Events.PLAYER_STOP, () => console.warn("[EVENT] Player stopped unexpectedly."));
      player.on(Clappr.Events.PLAYER_ENDED, () => console.log("[EVENT] Stream ended normally."));
    }

    function handleError() {
      console.warn(`[FAIL] Stream failed: ${servers[currentIndex]}`);
      showStatus(`‚ö†Ô∏è Stream failed ‚Äî trying backup...`, "#ff0");

      if (currentIndex + 1 < servers.length) {
        currentIndex++;
        const nextUrl = servers[currentIndex];
        console.log(`[FALLBACK] Switching to backup #${currentIndex + 1}: ${nextUrl}`);
        showStatus(`üîÅ Switching to Backup #${currentIndex + 1}`, "#ff6600");
        initPlayer(nextUrl);
      } else {
        console.error("[FAIL] All backups failed.");
        showStatus("‚ùå All servers failed. Please try again later.", "#f33");
        document.getElementById("player").innerHTML =
          "<h3>All servers failed. Please try again later.</h3>";
      }
    }

    loadStreams();
  </script>
</body>
</html>
