<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ayna Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">

  <!-- AES decryptor (your copy, unchanged) -->
  <script src="/aes.js"></script>

  <!-- Player libs -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; }
    #player { width:100%; height:100%; position:absolute; top:0; left:0; }
    @media (max-width:400px) {
      body { transform:scale(0.8); transform-origin:top left; width:125%; height:125%; }
    }
  </style>
</head>

<body>

<div id="player"></div>

<script>
// ----------------------------
// Extract AES values and set cookie
// ----------------------------
async function generateTokenCookie() {
    console.log("Retrieving AES page...");

    const response = await fetch(`/api/token?url=${encodeURIComponent("https://xfireflix.ct.ws/ayna/")}`);
    const html = await response.text();

    const match = html.match(
      /toNumbers\("([0-9a-f]+)"\)[\s\S]*toNumbers\("([0-9a-f]+)"\)[\s\S]*toNumbers\("([0-9a-f]+)"\)/
    );

    if (!match) {
        console.error("❌ AES keys not found in token page");
        return;
    }

    const [_, aHex, bHex, cHex] = match;

    const toNumbers = hex => hex.match(/../g).map(h => parseInt(h, 16));

    const a = toNumbers(aHex);
    const b = toNumbers(bHex);
    const c = toNumbers(cHex);

    const decrypted = slowAES.decrypt(c, 2, a, b);
    const token = decrypted.map(v => ("0" + v.toString(16)).slice(-2)).join("");

    document.cookie = `__test=${token}; path=/; max-age=21600`;
    console.log("✔ AES Cookie Set:", token);

    return token;
}

// ----------------------------
// Clappr Player
// ----------------------------
function createPlayer(url) {
    const player = new Clappr.Player({
        source: url,
        parentId: "#player",
        autoPlay: true,
        plugins: [HlsjsPlayback, LevelSelector],

        playback: {
          hlsjsConfig: {
            xhrSetup: xhr => {
              xhr.withCredentials = true;  // SEND AES COOKIE
            }
          }
        }
    });

    player.on(Clappr.Events.PLAYER_ERROR, () => {
        console.warn("Playback error—retrying...");
        setTimeout(() => {
          player.load(player.options.source);
          player.play();
        }, 500);
    });
}

// ----------------------------
// Find channel in JSON
// ----------------------------
async function loadChannel() {
    await generateTokenCookie();

    const idParam = new URLSearchParams(location.search).get("id");
    if (!idParam) return alert("Missing id");

    const json = await fetch("ayna-proxy.json").then(r => r.json());
    const list = json.data?.list || [];

    const match = list.find(x => x.title.toLowerCase() === idParam.toLowerCase());
    if (!match) return alert("Channel not found");

    const streamUrl = `/api/ayna.m3u8?id=${match.id}`;
    console.log("Streaming from:", streamUrl);

    createPlayer(streamUrl);
}

loadChannel();
</script>

</body>
</html>
