<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bostafull Player | Buddy✘TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Clappr Player Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/level-selector@0.2.0/dist/level-selector.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.0.1/dist/hlsjs-playback.min.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
  }

  #player {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  /* When screen width is below 400px, scale down entire page */
  @media (max-width: 400px) {
    body {
      transform: scale(0.8);
      transform-origin: top left;
      width: 125%;   /* compensate for scaling shrink */
      height: 125%;
    }
  }
</style>
</head>
<body>
  <div id="player"></div>
<script>
document.addEventListener("contextmenu", e => e.preventDefault());

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function createPlayer(url) {
  const player = new Clappr.Player({
    source: url,
    parentId: "#player",
    width: "100%",
    height: "100%",
    autoPlay: true,
    mimeType: "application/x-mpegURL",
    plugins: [HlsjsPlayback, LevelSelector],
    mediacontrol: { seekbar: "#ff0000", buttons: "#eee" }
  });

  player.on(Clappr.Events.PLAYER_ERROR, () => {
    setTimeout(() => {
      player.load(player.options.source);
      player.play();
    }, 1500);
  });

  player.on(Clappr.Events.PLAYER_STOP, () => player.play());
}

const requestedName = getQueryParam('id');

if (!requestedName) {
  document.body.innerHTML =
    "<h2 style='color:white;text-align:center;margin-top:20%'>No Channel Selected</h2>";
} else {

  const SOURCE_HTML = "https://example.com/sourcepage.html";

  // STEP 1 — Get channel ID from HTML
  fetch(SOURCE_HTML)
    .then(res => res.text())
    .then(html => {

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const scripts = [...doc.querySelectorAll('script')];
      const scriptWithChannels = scripts.find(s =>
        s.textContent.includes('const allChannels')
      );

      const jsText = scriptWithChannels.textContent;
      const match = jsText.match(/const allChannels\s*=\s*(\[[\s\S]*?\]);/);
      const channels = eval(match[1]);

      const found = channels.find(c =>
        c.name.trim().toLowerCase() === requestedName.trim().toLowerCase()
      );

      if (!found) throw new Error("Channel not found");

      // STEP 2 — Fetch master m3u8 using ID
      const masterUrl =
        `https://livecdn-bostaflix.global.ssl.fastly.net/stream.php/${found.id}.m3u8`;

      return fetch(masterUrl);
    })
    .then(res => res.text())
    .then(masterText => {

      // STEP 3 — Extract playlist token URL
      const match = masterText.match(/playlist\.m3u8\?token=[^\s]+/);

      if (!match) throw new Error("Playlist token not found");

      const tokenPart = match[0];

      // STEP 4 — Replace domain with your CDN
      const finalUrl =
        `https://livecdn-bostaflix.global.ssl.fastly.net/stream.php/${tokenPart}`;

      createPlayer(finalUrl);
    })
    .catch(err => {
      console.error(err);
      document.body.innerHTML =
        `<h2 style="color:white;text-align:center;margin-top:20%">Stream build failed</h2>`;
    });
}
</script>
</body>
</html>
